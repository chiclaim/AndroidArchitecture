# AndroidArchitecture

基于 Androidx Jetpack 封装 MVP、MVVM 架构最佳实践

## Jetpack 组件

关于 Jetpack 组件的介绍，网上有很多介绍的晦涩难懂。下面我尝试使用通俗易懂的语言来介绍诸如 Lifecycle、ViewModel、LiveData 等组件的推出的原因、解决的问题。

### Lifecycle

Lifecycle 顾名思义，生命周期的意思。在实际开发中，由于生命周期直接或间接引发的“血案”，比比皆是。

举个例子，我们在 bugly 后台可能经常发现如下错误信息：

```
Fragment not attached to a context
```

这个错误就是又生命周期问题导致的：Fragment 页面已经关闭，但 Fragment 里的定时任务或网络请求还在运行，任务完成后进行 UI 操作（内存泄漏）。

其实，在官网上关于 Lifecycle 的 [案例](https://developer.android.com/topic/libraries/architecture/lifecycle) 也很好的说明了关注生命周期的重要的性。

另外，每个人的开发水平是不一样的，那有没有一种方法让开发者更少的关注让人头痛的生命周期问题，让开发者把更多的精力放在具体的业务上呢？

于是，Google 推出了 Jetpack 系列组件，其中 Lifecycle 组件让开发者更加便利的感知组件的生命周期，同时它也是 ViewModel、LiveData 组件的基础。


### ViewModel

有了 Lifecycle 组件，为什么还需要 ViewModel 组件？

我们上面提到了，Jetpack 的推出是为了让开发者将精力聚焦在业务上，至于生命周期导致的问题应该统一由架构来完成。

Lifecycle 组件只是让开发者更便利的管理生命周期，但是开发者还是需要考虑很多情景，然后编写相应的代码来处理。

举个例子：当 Activity 界面发生重建（Configuration changes）时，我们常常需要将 `关键的数据` 在 `onSaveInstanceState` 方法中进行保存，以便在 `onCreate` 方法中进行恢复。

在上面的例子中，开发者至少要做以下几件事情：

- 在 onSaveInstanceState 方法中保存数据
- 在 onCreate 尝试恢复数据
- 只能保存 Bundle 支持的数据类型，复杂类型还需要实现 Serializable 或 Parcelable 接口，数据量大了性能也不佳

可见为了处理界面 `Configuration changes` 的情景，开发者还是需要编写很多额外的代码。这些“额外的代码”，仅仅是为了维护界面交互数据的一致性的。

何谓”界面交互数据的一致性“？例如这样一个场景：你想给你的好友分享一篇你觉得很好的文章，点击分享后，进入好友列表，然后你选中了 10 个好友，此时不小心将竖屏转成横屏了，那么在横屏后界面还是应该选中你竖屏选中的 10 个好友的。如果你在代码中不做任何处理，在竖屏到横屏的切换后，界面的会重新请求数据，并且选择的 10 个好友也会处于未被选中的状态（这种体验是很糟糕的）。

此时，ViewModel 就闪亮登场了。ViewModel 被设计用于以感知生命周期的方式来管理和存储 UI 界面相关的数据。ViewModel 可以存储任意你保存的数据（例如界面的列表数据），并且会自动恢复数据。很好的解决了上面提到的“界面交互数据的一致性”问题，也不用编写“额外的代码”。

“界面交互数据的一致性”是我自己提炼的术语，只是为了能够简练地描述清楚 ViewModel 的功能。如果一上来直接讲术语读者是听不懂的。

更进一步地，我们可以这样来概括：ViewModel 是为了将组件的 `生命周期` 和 `数据` 进行 **脱敏** 的。

这里的 “脱敏”，我称之为 “脱离敏感”，组件的生命周期和数据之间的关联是非常敏感的，只要是生命周期发生了变化，那么就可能导致数据被重新请求（流量、用户等待）而且还容易丢失用户在交互中产生的数据（交互体验变差）。

**任你生命周期怎么变化，都会保持数据的一致性。**

所以总结一句话就是：ViewModel 的目的是为了保持“界面交互数据的一致性”，途径是通过“脱敏”。


### LiveData




### Jetpack 小结



- Lifecycle 更方便地让开发者感知界面的生命周期。
- ViewModel 解决了界面的生命周期与界面数据的一致性问题。
- LiveData  解决了有效生命周期的数据的更新问题，LiveData 中的 Live 有“活着的”意思。它能保证组件在激活的状态下被更新。

> 可以看出 Google 推出的 Jetpack，都是为了提高 Android app 的稳定性、用户使用的体验感，从而让用户一直留在 Android 生态，与此同时，也减轻了开发者的负担。






